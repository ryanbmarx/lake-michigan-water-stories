{% extends "_base.html" %}

{% macro photo_arr(design_str, p2p_collection_slug_str, image_width, display_caption_bool, display_credit_bool, add_class_str) %}
  <div class='photo-arr photo-arr--{{ design_str }} {{ add_class_str }}'>
  {% if design_str|int == 0 %}
    {# ZERO means a gallery #}
    {{ gallery(p2p_collection_slug_str, display_caption_bool, display_credit_bool, image_width) }}
  {% else %}
    {# OTHERWISE WE'LL JUST USE CSS TO ARRANGE THE PHOTOS #}
    {% set limit = design_str|get_photo_limit %}
    {% for img in get_p2p_content_item(p2p_collection_slug_str)['related_items'][0:limit] %}
      {{ add_p2p_photo(img['slug'], "", image_width, display_caption_bool, display_credit_bool) }}
    {% endfor %}
  {% endif %}
  </div>
{% endmacro %}


{% macro gallery(slug, show_caption_bool, show_credit_bool, image_width) %}
  {# TODO: Make photo size respect the river #}
  <div class="swiper-container">
    <!-- Additional required wrapper -->
    <div class="swiper-wrapper">
      {% for img in get_p2p_content_item(slug)['related_items'] %}
        {% if show_caption_bool %}
          {% set caption = img.content_item.caption %}
        {% else %}
          {% set caption = False %}
        {% endif %}

        {% if show_credit_bool %}
          {% set credit = img.content_item.credit %}
        {% else %}
          {% set credit = False %}
        {% endif %}

        <div class="swiper-slide">
          {{ add_p2p_photo(img['slug'], "", image_width, caption, credit, True) }}
          {# <div class="swiper-lazy-preloader"></div> #}
        </div>
      {% endfor %}
    </div>
    <!-- If we need pagination -->
    <div class="swiper-pagination"></div>
    
    <!-- If we need navigation buttons -->
    <div class="swiper-button-prev"></div>
    <div class="swiper-button-next"></div>
    
    <!-- If we need scrollbar -->
    {# <div class="swiper-scrollbar"></div> #}
</div>
{% endmacro %}

{% macro aside(aside_type, add_class) %}
    {% if aside_type == 'subscribe' %}
      {% set refer_url = refers[aside_type + "_url"]['text'] %}
    {% else %}
      {% set refer_url = "http://" + ROOT_URL + "/" + refers[aside_type + "_url"]['text'] %}
    {% endif %}

    <aside class='refer refer--{{ aside_type }} {% if add_class %} {{ add_class }} {% endif %}'>
        <h3 class='refer__headline'>{{ refers[aside_type + "_headline"]['text']|dumb_to_smart_quotes|process_text() }}</h3>
        <p class='refer__blurb'>{{ refers[aside_type + "_text"]['text']|dumb_to_smart_quotes|process_text() }}</p>
        {% if  refers[aside_type + "_url"] and refers[aside_type + "_button_text"] %}
            <a class='refer__button' href='{{ refer_url }}' target="_blank">{{ refers[aside_type + "_button_text"]["text"] }}</a>
        {% endif %}
    </aside>
{% endmacro %}


{% macro add_photo(url, add_class, caption, alt) %}
  <figure class='image {{ add_class }}'>
    <img src='{{ url }}' alt='{{ alt }}'/>
    <figcaption> {{ caption }}</figcaption>
</figure>
{% endmacro %}

{% macro add_p2p_photo(slug, add_class, width, display_caption, display_credit, lazy_load=False) %}
  {% set photo = get_p2p_content_item(slug) %}
  {% if photo|check_if_is_okay_to_publish %}
  
  {% set caption = "" %}
  
  {% if display_caption %}
    {% set caption = caption + "<figcaption>" + photo.caption|striptags|strip_whitespace %}
  {% endif %}
  
  {% if display_credit %}
    {% set caption = caption + " (" + photo.credit|striptags|strip_whitespace + ")" %}
  {% endif %}

  {% if display_caption %}
    {% set caption = caption + "</figcaption>" %}
  {% endif %}

  {% if lazy_load %}

    {% set src = "src=" ~ photo.photo_services_url ~ "/" ~ width %}
    {#
      TODO: Fix lazy loading for galleries. 
      {% set src = "data-src=" ~ photo.photo_services_url ~ "/" ~ width %} 
    #}
  {% else %}
    {% set src = "src=" ~ photo.photo_services_url ~ "/" ~ width %}
  {% endif %}
      <figure class='image {{ add_class }}'>
        <img class="{% if lazy_load %}{{ 'swiper-lazy' }}{% endif %}" {# src='{{ photo.photo_services_url }}/{{ width }}' #} {{ src }} {# low-res-src='{{ photo.photo_services_url }}/10' #} alt='{{ photo.title }}' title='{{ photo.title }}'/>
        {{ caption|process_text }}
      </figure>
    {% else %}
      <p style='padding:20px;background:red; color:yellow'>Photo (slug: {{ slug }}) is not set to "live"</p>  
    {% endif %}
{% endmacro %}

{% macro ad(type, alignment) %}
    {# returns an advert <div> with the proper alignment classes and data-* attributes to make it fit within this project. #}
    {% if alignment %}
        {% set class = "advert--" + alignment%}
    {% endif %}

    {% if type == "cube" %}
        <div class="advert {{ class }}" data-ad-type="shrinky-cube"></div>
    {% elif type == "leaderboard" %}
        <div class="advert" data-ad-type="leaderboard"></div>
    {% endif %}
{% endmacro %}

{% macro keep_scrolling_icon() %}
  <div class='story-header__scrolling-icon'>
    <span>{{ scrolling_icon_text }}</span>
    <i class="fa fa-arrow-circle-down fa-2x" aria-hidden="true"></i>
  </div>

{% endmacro %}

{% macro pullquote(quote_text, quote_attribution, quote_attribution_secondary) %}
    
  {% set page_url = "http://" + ROOT_URL + "/" + PATH %}
  
  {% set tweet = quote_text + ' #TaxDivide from @chicagotribune' %}
    <figure class="trib-pullquote">
        <ul class="social-menu">
            <li>
                <a target="_blank" href="https://twitter.com/share?url={{ page_url }}&text={{ tweet|urlencode }}">
                    <i class="fa fa-twitter fa-2x" aria-hidden="true"></i>
                    <span class="hidden">Twitter</span>
                </a>
            </li>
            <li>
                <a target="_blank" href="https://www.facebook.com/sharer.php?u={{ page_url }}&t={{ quote_text|urlencode }}">
                    <i class="fa fa-facebook fa-2x" aria-hidden="true"></i>
                    <span class="hidden">Facebook</span>
                </a>
            </li>
        </ul>
{#         <p>{{ quote_text|length }} CHARS QUOTE</p>
        <p>{{ tweet|length }} CHARS TOTAL</p> #}
        <blockquote>{{ quote_text|dumb_to_smart_quotes|process_text() }}</blockquote>
        {% if quote_attribution %}
            <figcaption>
                {{ quote_attribution|process_text() }}
                {% if quote_attribution_secondary|process_text() %}<span>{{ quote_attribution_secondary|process_text() }}</span>{% endif %}
            </figcaption>
        {% endif %}
    </figure>
    
{% endmacro %}

{% macro add_chart(id, addon_class, url) %}
    {% if addon_class %}
        {% set class = addon_class %}
    {% else %}
        {% set class = "" %}
    {% endif %}
    <div class='chart chart--{{ id }} {{ class }}'>      
        <div id='{{ id }}' class='graphic-embed' data-iframe-url='{{ url }}'></div>
        {# {% include "_subtemplates/_loading-spinner.html" %} #}
    </div>
{% endmacro %}

{% macro add_video(id, addon_class="", header, video_slug) %}

    {% set video = get_p2p_content_item(video_slug) %}

    {% if addon_class %}
        {% set class = addon_class %}
    {% else %}
        {% set class = "" %}
    {% endif %}
   <div class='video {{ class }}'>
      {% if header %}
        <h4 class='video__headline'>{{ header }}</h4>
      {% endif %}
       <div class='video__wrapper'>
        <div class='video__object-wrapper'>
          <video data-account="3690581440001"
            data-player="BylPHnG8"
            data-embed="default"
            data-video-id="ref:{{ video['id'] }}"
            data-application-id
            tabindex="-1" 
            class="video-js"
            controls></video>
        </div>
      </div>
    </div>
{% endmacro %}

{% macro add_author(name, email) %}
  <a itemprop="author" {% if email %}href="mailto:{{- email -}}?subject=Regarding: {{ overall_project_title }}"{% endif %}>{{- name -}}</a>
{% endmacro%}

{% block nav scoped %}
  {% set part = part %}
  {% include 'subtemplates/_nav.html' %}
{% endblock nav %}

{% block opengraph scoped %}
  {% set part = part %}

  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:site" content="@chicagotribune" />
  <meta name="twitter:creator" content="@kcecireyes" />
  <meta name="twitter:creator" content="@tgregoryreports" />
  {# <meta name="twitter:creator" content="@OCONNEL?" /> #}
  <meta name="twitter:creator" content="@AngelaTCR" />

  <meta property="og:url" content="http://{{ ROOT_URL }}/{{ PATH }}" />
  <meta name="keywords" content="{{ keywords }}">
  {% block opengraph_story_specific scoped %}

    <meta name="twitter:title" content="{{ title }}" />
    <meta name="twitter:description" content="{{ og_description }}" />
    <meta name="twitter:image" content="{{ og_image }}" />
    <meta name="twitter:image:alt" content="{{ og_image_alt_text }}" />
    {# OPENGRAPH #}
    <meta property="og:title" content="{{ title }}" />
    <meta property="og:description" content="{{ og_description }}" />
    <meta property="og:image" content="{{ og_image }}" />
  {% endblock opengraph_story_specific %}
{% endblock %}

{% block content %}
    {# 
    Remove ad per convo with Kaarin, JB and Kurt.
    {{ ad('leaderboard', false) }} 
    #}
    {% block story_header scoped %}
    <article>
      {% set part = part %}
      {% include 'subtemplates/' + part + '/_header-supplement.html' ignore missing %}
        <section class='story-header story-header--{{ part }}'>
          <div class='story-header__inner'>
            <div class='story-header__project-title'>
              <p>{{ title_prefix }}: <br />{{ title }}</p>
            </div>

            <h2 class='story-header__headline'>
              {% block headline %}{% endblock headline %}
            </h2>
            <h1 class='story-header__subheadline' itemprop="headline">
              {% block dek %}{% endblock dek %}
            </h1>
          </div>
          <div class='container'>
            <div class='river--narrow'>
              {# SOCIAL MEDIA BUTTONS  #}
              {% set page_url =  "http://" + ROOT_URL + "/" + PATH %}
              <ul class="social-menu">
                <li>
                  <a target="_blank" href="https://twitter.com/share?url={{ page_url }}&text={% block tweet %}{{ twitter_description|urlencode }}{% endblock tweet%}">
                    <i class="fa fa-twitter fa-2x"></i> <span class="hidden">Twitter</span>
                  </a>
                </li>
                <li>
                  <a target="_blank" href="https://www.facebook.com/sharer.php?u={{ page_url }}&t={% block facebook %}{{ og_description|urlencode }}{% endblock facebook %}">
                    <i class="fa fa-facebook fa-2x"></i> <span class="hidden">Facebook</span>
                  </a>
                </li>
              </ul>
              <div class='byline'>
                <p class='byline-name'>By {% block byline %}{% endblock byline%}</p>
                <time class='byline-publish-date' itemprop="datePublished">Published: {{ publish_date|xldate_to_datetime|format_date("%B %d, %Y") }}</time>
              </div>
            </div>
          </div>
        </section>
    {% endblock story_header %}
        <div class="container" itemprop="articleBody">
          <div class='river--narrow'>{% block story %}{% endblock story %}</div>
        </div>
        </article>
    {% block credits scoped %}
      {% set part = part %}
      {% include 'subtemplates/_credits.html' %}      
    {% endblock credits %}
    {% block solid_opinion_comments scoped %}
      {#  The comments require a unique id in the data-attribute, so we'll fashion one 
          using the part variable.
      #}
      {% set part = "water-comments--" + part %}
      {% include 'subtemplates/_solid-opinion-comments.html'%}
      <div data-trb-thirdpartynav></div>
    {% endblock solid_opinion_comments %}
{% endblock content %}


{% block comments %}{% endblock comments %}


{% block library_css %}
    <link rel="stylesheet" type="text/css" href="css/base.css" />
{% endblock %}

{% block css %}
    <link rel="stylesheet" href="https://use.fontawesome.com/6745e48e70.css">
    <link rel="stylesheet" type="text/css" href="css/styles.css">
{% endblock %}

{% block meta %}
    {{ super() }}
{#     <meta http-equiv="X-UA-Compatible" content="IE=edge">   
 #}{% endblock meta %}



{% block scripts %}
    <script src="http://{{ ROOT_URL }}/js/app.min.js"></script>
    {# <script>brightcove.createExperiences();</script> #}
{% endblock scripts %}

{% block chartbeat %}
    {% include 'subtemplates/_chartbeat.html' %}
{% endblock %}

{% block omniture_scripts %}
    {{ super() }}
    {# <script src="http://www.chicagotribune.com/thirdpartyservice?disablenav=true" async></script> #}
    <script src="//players.brightcove.net/3690581438001/BylPHnG8_default/index.min.js"></script>

{% endblock omniture_scripts %}


{% block omniture %}
{% endblock omniture %}

{% block library_scripts %}
  {# <script src="https://cdnjs.cloudflare.com/ajax/libs/Swiper/3.4.2/js/swiper.min.js"></script> #}
  {% include 'subtemplates/_omniture_header_scripts.html' %}

  {# For the bootstrap. Can this be removed? #}
  <script src="//cdnjs.cloudflare.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script>

  {# For the adverts #}
  <script src="//media.apps.chicagotribune.com/ads/v2.1.4/ads.min.js" defer async></script>

  {# METER #}
  <script type="text/javascript" src="//www.tribdss.com/meter/ctcngux.min.js" defer async></script>

  {# For some of the JS I wrote, I need this. #}
  <script type="text/javascript">
    window.ROOT_URL = "{{ ROOT_URL }}";
  </script>

{% endblock %}

{% block shim %}{% endblock shim %}

{% block paywall %}
  {# COMMENTS #}
  <script src="http://ssor.tribdss.com/reg/tribune/chinews-apps.min.js"></script>
{% endblock paywall %}
